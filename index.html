<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dofus Look Renderer</title>
  <style>
    :root {
      --bg-light: #f7f7f7;
      --bg-dark: #181a1b;
      --text-light: #222;
      --text-dark: #f7f7f7;
      --accent: #4e9cff;
    }
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: var(--bg-dark);
      color: var(--text-dark);
      transition: background 0.2s, color 0.2s;
    }
    .light {
      background: var(--bg-light);
      color: var(--text-light);
    }
    .container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      padding: 2rem 1rem;
      max-width: 1200px;
      margin: auto;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin-bottom: 2rem;
      padding: 1rem;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
    }
    .search-mode {
      display: flex;
      gap: 1rem;
    }
    .search-mode label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
    }
    .slider-label {
      min-width: 120px;
    }
    input[type="text"] {
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid #555;
      background: #333;
      color: #fff;
      width: 200px;
    }
    .light input[type="text"] {
      background: #fff;
      color: #333;
      border: 1px solid #ddd;
    }
    .light select {
      background: #fff;
      color: #333;
      border: 1px solid #ddd;
    }
    button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      background: var(--accent);
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: #3d7dd6;
    }
    .theme-toggle {
      margin-left: auto;
      border-radius: 20px;
    }
    .theme-toggle.light {
      background: #222;
    }
    .images {
      display: flex;
      gap: 2rem;
      justify-content: center;
      align-items: flex-start;
      flex-wrap: nowrap;
    }
    .img-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      min-width: 200px;
    }
    img {
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      max-width: 100%;
      height: auto;
    }
    #npc-info {
      margin-bottom: 2rem;
    }
    .npc-result {
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      display: flex;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 1rem;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .npc-info-section {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      min-width: 300px;
      flex: 1;
    }
    .npc-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    .npc-images {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .npc-img-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
    }
    .npc-img-block img {
      border-radius: 6px;
      background: rgba(255,255,255,0.1);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      max-width: 80px;
      max-height: 80px;
      width: auto;
      height: auto;
    }
    .npc-img-block span {
      font-size: 0.7rem;
      opacity: 0.8;
    }
    .gender-badge {
      padding: 2px 8px;
      border-radius: 6px;
      font-weight: bold;
      color: #fff;
      font-size: 0.8rem;
    }
    .name-langs {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
    }
    .name-lang {
      padding: 1px 4px;
      border-radius: 3px;
      background: rgba(255,255,255,0.1);
      font-size: 0.8rem;
    }
    @media (max-width: 900px) {
      .images {
        flex-direction: column;
        gap: 1.5rem;
      }
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      .search-mode {
        justify-content: center;
      }
      .npc-result {
        flex-direction: column;
        align-items: stretch;
      }
      .npc-info-section {
        min-width: auto;
      }
      .npc-images {
        justify-content: center;
      }
    }
    .footer {
      margin-top: 3rem;
      padding: 1rem;
      text-align: center;
      font-size: 0.8rem;
      opacity: 0.7;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .npc-result {
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }
    .npc-result:hover {
      background: rgba(255,255,255,0.08);
      transform: translateY(-1px);
    }
    .npc-result.selected {
      background: rgba(78, 156, 255, 0.1);
      border-color: rgba(78, 156, 255, 0.3);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="controls">
      <div class="search-mode">
        <label for="search-mode-look">
          <input type="radio" name="search-mode" id="search-mode-look" value="look" checked> 
          By Look
        </label>
        <label for="search-mode-name">
          <input type="radio" name="search-mode" id="search-mode-name" value="name"> 
          By Name
        </label>
      </div>
      <input id="look-input" type="text" value="{6583|||120}" placeholder="Enter look string or name..." />
      <select id="language-select" style="padding:0.5rem; border-radius:6px; border:1px solid #555; background:#333; color:#fff;">
        <option value="fr">French</option>
        <option value="en">English</option>
        <option value="es">Spanish</option>
        <option value="pt">Portuguese</option>
        <option value="de">German</option>
      </select>
      <span class="slider-label">Size: <span id="size-value">250</span>x<span id="size-value2">250</span></span>
      <input id="size-slider" type="range" min="50" max="750" step="100" value="250" />
      <span class="slider-label">Results: <span id="results-value">10</span></span>
      <input id="results-slider" type="range" min="1" max="50" step="1" value="10" />
      <button id="render-btn">Render</button>
      <button id="theme-toggle" class="theme-toggle">Light mode</button>
      <label for="enable-ankama">
        <input type="checkbox" id="enable-ankama" />
        Enable Ankama Renderer
      </label>
    </div>
    
    <div id="npc-info"></div>
    
    <div class="images">
      <div class="img-block">
        <span>Ankama Renderer</span>
        <img id="ankama-img" src="" alt="Ankama Look" style="display:none;" />
        <a id="ankama-link" href="#" target="_blank" style="font-size:0.9em;display:none;">Open image</a>
      </div>
      <div class="img-block">
        <span>DofusDB Renderer</span>
        <img id="dofusdb-img" src="" alt="DofusDB Look" style="display:none;" />
        <a id="dofusdb-link" href="#" target="_blank" style="font-size:0.9em;display:none;">Open image</a>
      </div>
    </div>
    
    <footer class="footer">
      <p>Â© Ankama Games - Dofus character renders and game data</p>
      <p>NPC metadata sourced from the fansite <a href="https://dofusdb.fr" target="_blank" style="color: var(--accent);">DofusDB.fr</a></p>
    </footer>
  </div>

  <script>
    // Convert string to hex for Ankama renderer
    function toAnkamaHex(str) {
      let hex = '';
      for (let i = 0; i < str.length; i++) {
        hex += str.charCodeAt(i).toString(16);
      }
      return hex;
    }

    // Get DOM elements
    const lookInput = document.getElementById('look-input');
    const languageSelect = document.getElementById('language-select');
    const sizeSlider = document.getElementById('size-slider');
    const sizeValue = document.getElementById('size-value');
    const sizeValue2 = document.getElementById('size-value2');
    const resultsSlider = document.getElementById('results-slider');
    const resultsValue = document.getElementById('results-value');
    const renderBtn = document.getElementById('render-btn');
    const ankamaImg = document.getElementById('ankama-img');
    const ankamaLink = document.getElementById('ankama-link');
    const dofusdbImg = document.getElementById('dofusdb-img');
    const dofusdbLink = document.getElementById('dofusdb-link');
    const themeToggle = document.getElementById('theme-toggle');
    const npcInfo = document.getElementById('npc-info');
    const searchModeLook = document.getElementById('search-mode-look');
    const searchModeName = document.getElementById('search-mode-name');
    const enableAnkamaCheckbox = document.getElementById('enable-ankama');
    
    let darkMode = true;

    // Update size label when slider changes
    function updateSizeLabel() {
      const size = sizeSlider.value;
      sizeValue.textContent = size;
      sizeValue2.textContent = size;
    }
    
    // Update results label when slider changes
    function updateResultsLabel() {
      resultsValue.textContent = resultsSlider.value;
    }
    
    sizeSlider.addEventListener('input', updateSizeLabel);
    resultsSlider.addEventListener('input', updateResultsLabel);
    updateSizeLabel();
    updateResultsLabel();

    // Main render function
    async function renderImages() {
      const input = lookInput.value.trim();
      
      if (!input) {
        alert('Please enter a look string or name');
        return;
      }

      const size = parseInt(sizeSlider.value);
      
      // Clear previous results
      hideImages();
      npcInfo.innerHTML = '<em>Loading...</em>';

      try {
        if (searchModeLook.checked) {
          await renderByLook(input, size);
        } else {
          await renderByName(input, size);
        }
      } catch (error) {
        console.error('Error:', error);
        npcInfo.innerHTML = `<span style="color:#e74c3c">Error: ${error.message}</span>`;
      }
    }

    // Render by look string
    async function renderByLook(look, size) {
      if (!look.startsWith('{') || !look.endsWith('}')) {
        throw new Error('Look string must be wrapped in curly braces, e.g. {6583|||120}');
      }

      const hex = toAnkamaHex(look);
      
      // Show images
      showImages(hex, size);
      
      // Fetch NPC info
      await fetchNpcInfo('look', look);
    }

    // Render by name
    async function renderByName(name, size) {
      hideImages();
      await fetchNpcInfo('name', name);
      
      // If we found NPCs, show the first one's look as images
      const firstNpc = await getFirstNpcFromSearch('name', name);
      if (firstNpc && firstNpc.look) {
        const hex = toAnkamaHex(firstNpc.look);
        showImages(hex, size);
      }
    }

    // Show rendered images (modified to respect Ankama renderer setting)
    function showImages(hex, size) {
      const dofusdbUrl = `https://renderer.dofusdb.fr/look/${hex}/full/1/${size}_${size}.png`;

      // Ankama renderer logic
      if (enableAnkamaCheckbox.checked) {
        const ankamaUrl = `https://staticns.ankama.com/dofus/renderer/look/${hex}/full/1/${size}_${size}-0.png`;
        ankamaImg.src = ankamaUrl;
        ankamaImg.style.display = 'block';
        ankamaLink.href = ankamaUrl;
        ankamaLink.style.display = 'block';
      } else {
        ankamaImg.style.display = 'none';
        ankamaLink.style.display = 'none';
      }

      // DofusDB renderer logic
      dofusdbImg.src = dofusdbUrl;
      dofusdbImg.style.display = 'block';
      dofusdbImg.style.width = size + 'px';
      dofusdbImg.style.height = size + 'px';
      dofusdbLink.href = dofusdbUrl;
      dofusdbLink.style.display = 'block';
    }

    // Hide images
    function hideImages() {
      ankamaImg.style.display = 'none';
      ankamaLink.style.display = 'none';
      dofusdbImg.style.display = 'none';
      dofusdbLink.style.display = 'none';
    }

    // Fetch NPC information from DofusDB API
    async function fetchNpcInfo(searchType, query) {
      try {
        const resultsLimit = parseInt(resultsSlider.value);
        let url;
        if (searchType === 'look') {
          url = `https://api.beta.dofusdb.fr/npcs?look=${encodeURIComponent(query)}&$limit=${resultsLimit}`;
        } else {
          const selectedLanguage = languageSelect.value;
          url = `https://api.beta.dofusdb.fr/npcs?name.${selectedLanguage}[$regex]=${encodeURIComponent(query)}&$limit=${resultsLimit}`;
        }

        const response = await fetch(url, {
          headers: {
            'Referer': 'https://nelsonjq.github.io/npc-d3-look-display/'
          }
        });
        
        if (!response.ok) {
          throw new Error(`API request failed: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.data || data.data.length === 0) {
          npcInfo.innerHTML = `<span style="color:#e74c3c">No NPC found for this ${searchType}.</span>`;
          return;
        }

        // Display results
        npcInfo.innerHTML = data.data.slice(0, resultsLimit).map(npc => renderNpcBlock(npc)).join('');
        
      } catch (error) {
        throw new Error(`Failed to fetch NPC info: ${error.message}`);
      }
    }

    // Helper function to get first NPC from search (for displaying images in name search)
    async function getFirstNpcFromSearch(searchType, query) {
      try {
        let url;
        if (searchType === 'look') {
          url = `https://api.beta.dofusdb.fr/npcs?look=${encodeURIComponent(query)}&$limit=1`;
        } else {
          const selectedLanguage = languageSelect.value;
          url = `https://api.beta.dofusdb.fr/npcs?name.${selectedLanguage}[$regex]=${encodeURIComponent(query)}&$limit=1`;
        }

        const response = await fetch(url);
        
        if (!response.ok) {
          return null;
        }
        
        const data = await response.json();
        
        if (!data.data || data.data.length === 0) {
          return null;
        }

        return data.data[0];
        
      } catch (error) {
        return null;
      }
    }

    // Render individual NPC block
    function renderNpcBlock(npc) {
      const genderColors = ['#4e9cff', '#e67ee6', '#aaa'];
      const genderLabels = ['Male', 'Female', 'Unknown'];
      const gender = npc.gender ?? 2;
      const color = genderColors[gender] || '#aaa';
      const label = genderLabels[gender] || 'Unknown';

      let names = '';
      if (npc.name && typeof npc.name === 'object') {
        names = Object.entries(npc.name)
          .filter(([k, v]) => k !== 'id' && v)
          .map(([lang, val]) => `<span class="name-lang">${lang}: ${val}</span>`)
          .join(' ');
      }

      // Generate image URLs if look exists
      let imagesHtml = '';
      if (npc.look) {
        const hex = toAnkamaHex(npc.look);
        const imageSize = 80; // Fixed small size for result thumbnails
        const ankamaUrl = `https://staticns.ankama.com/dofus/renderer/look/${hex}/full/1/${imageSize}_${imageSize}-0.png`;
        const dofusdbUrl = `https://renderer.dofusdb.fr/look/${hex}/full/1/${imageSize}_${imageSize}.png`;

        imagesHtml = `
          <div class="npc-images">
            <div class="npc-img-block">
              <img src="${ankamaUrl}" alt="Ankama" onerror="this.style.display='none'" style="display: ${enableAnkamaCheckbox.checked ? 'block' : 'none'};">
              <span>Ankama</span>
            </div>
            <div class="npc-img-block">
              <img src="${dofusdbUrl}" alt="DofusDB" onerror="this.style.display='none'">
              <span>DofusDB</span>
            </div>
          </div>
        `;
      } else {
        imagesHtml = '<div class="npc-images"><em style="opacity:0.6;">No look data</em></div>';
      }

      return `
        <div class="npc-result" onclick="selectNpcForRender('${npc.look || ''}', ${npc.id})" data-npc-id="${npc.id}">
          <div class="npc-info-section">
            <div class="npc-badges">
              <span class="gender-badge" style="background:${color};">${label}</span>
              <span style="font-weight:bold; background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px; font-size:0.8rem;">ID: ${npc.id}</span>
              ${npc.look ? '<span style="font-size:0.7rem; opacity:0.8; font-style:italic;">Click to render</span>' : ''}
            </div>
            <div class="name-langs">${names}</div>
            ${npc.look ? `<div style="font-size:0.7rem; opacity:0.7; font-family:monospace;">Look: ${npc.look}</div>` : ''}
          </div>
          ${imagesHtml}
        </div>
      `;
    }

    // Select NPC for main render display
    function selectNpcForRender(look, npcId) {
      if (!look) return;
      
      // Remove selected class from all results
      document.querySelectorAll('.npc-result').forEach(el => el.classList.remove('selected'));
      
      // Add selected class to clicked result
      document.querySelector(`[data-npc-id="${npcId}"]`).classList.add('selected');
      
      // Update main render with this NPC's look
      const hex = toAnkamaHex(look);
      const size = parseInt(sizeSlider.value);
      showImages(hex, size);
      
      // Update input field to show current look
      lookInput.value = look;
      
      // Switch to look mode if not already
      searchModeLook.checked = true;
    }

    // Theme toggle
    function toggleTheme() {
      darkMode = !darkMode;
      document.body.classList.toggle('light', !darkMode);
      themeToggle.textContent = darkMode ? 'Light mode' : 'Dark mode';
      themeToggle.classList.toggle('light', !darkMode);
    }

    // Event listeners
    renderBtn.addEventListener('click', renderImages);
    themeToggle.addEventListener('click', toggleTheme);

    // Allow Enter key to trigger render
    lookInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        renderImages();
      }
    });

    // Initialize
    document.body.classList.remove('light');
    themeToggle.textContent = 'Light mode';
    themeToggle.classList.remove('light');
    
    console.log('Dofus Look Renderer loaded successfully!');
  </script>
</body>
</html>
